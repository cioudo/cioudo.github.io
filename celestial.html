<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>Celestial Dashboard</title>

</head>

<body>
    <form id="registerForm">
        <h2>Sign Up</h2>
        <label for="registerUsername">Username:</label>
        <input type="text" id="registerUsername" name="registerUsername" required>
        <label for="registerPassword">Password:</label>
        <input type="password" id="registerPassword" name="registerPassword" required>
        <input type="submit" value="Register">
    </form>

    <form id="loginForm">
        <h2>Login</h2>
        <label for="loginUsername">Username:</label>
        <input type="text" id="loginUsername" name="loginUsername" required>
        <label for="loginPassword">Password:</label>
        <input type="password" id="loginPassword" name="loginPassword" required>
        <input type="submit" value="Login">
    </form>

    <div id="userInfo" style="display: none;">
        <h2>User Information</h2>
        <p id="userBalance"></p>
    </div>

    <div id="giveCoinsSection" style="display: none;">
        <h2>Give Celestial Coins</h2>
        <form id="giveCoinsForm">
            <label for="recipient">Recipient Username:</label>
            <input type="text" id="recipient" name="recipient" required>
            <label for="amount">Amount of Celestial Coins:</label>
            <input type="number" id="amount" name="amount" required>
            <input type="submit" value="Give">
        </form>
    </div>

    <script>
        function hideElementById(id) {
            var element = document.getElementById(id);
            if (element) {
                element.style.display = 'none';
            }
        }
        
        async function addLineToGitHubFile(content, filePath) {
            const accessToken = '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'; // Replace this with your GitHub Access Token
            const owner = 'cioudo'; // Replace this with your username or organization name
            const repo = 'creds'; // Replace this with the repository name

            const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`, {
                method: 'GET',
                headers: {
                    Authorization: `token ${accessToken}`,
                },
            });
            const data = await response.json();
            const currentContent = atob(data.content);

            const updatedContent = currentContent + '\n' + content;
            const encodedContent = btoa(updatedContent);

            await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`, {
                method: 'PUT',
                headers: {
                    Authorization: `token ${accessToken}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: 'Adding new line via API',
                    content: encodedContent,
                    sha: data.sha,
                }),
            });

            alert('Line successfully added to GitHub file!');
        }

        async function loginWithGitHubFile(username, password) {
            const accessToken = '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'; // Replace this with your GitHub Access Token
            const owner = 'cioudo'; // Replace this with your username or organization name
            const repo = 'creds'; // Replace this with the repository name
            const filePath = 'creds.txt'; // Replace this with the path to the file in the repository

            const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`, {
                method: 'GET',
                headers: {
                    Authorization: `token ${accessToken}`,
                },
            });
            const data = await response.json();
            const currentContent = atob(data.content);
            const credentials = currentContent.split('\n').map(line => line.split(':'));
            const foundUser = credentials.find(([storedUsername, storedPassword]) => storedUsername === username && storedPassword === password);

            if (foundUser) {
                alert('Login successful!');

                // Fetch and display balance after logging in
                hideElementById('loginForm')
                hideElementById('registerForm')

                await getUserBalance(username);
                document.getElementById("giveCoinsSection").style.display = "block"; // Show the Give form after successful login
            } else {
                alert('Invalid username or password. Please try again.');
            }
        }

        async function giveCelestialCoins(sender, recipient, amount) {
            const accessToken = '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'; // Replace this with your GitHub Access Token
            const owner = 'cioudo'; // Replace this with your username or organization name
            const repo = 'creds'; // Replace this with the repository name
            const filePath = 'balances.txt'; // Replace this with the path to the file in the repository

            const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`, {
                method: 'GET',
                headers: {
                    Authorization: `token ${accessToken}`,
                },
            });
            const data = await response.json();
            const currentContent = atob(data.content);
            const balances = currentContent.split('\n').map(line => line.split(':'));
            const senderBalanceIndex = balances.findIndex(([storedUsername]) => storedUsername === sender);
            const recipientBalanceIndex = balances.findIndex(([storedUsername]) => storedUsername === recipient);

            if (senderBalanceIndex !== -1 && recipientBalanceIndex !== -1) {
                const senderBalance = parseFloat(balances[senderBalanceIndex][1]) || 0;
                if (amount > senderBalance) {
                    alert('Insufficient balance.');
                } else {
                    const newSenderBalance = senderBalance - amount;
                    balances[senderBalanceIndex][1] = newSenderBalance;

                    const recipientBalance = parseFloat(balances[recipientBalanceIndex][1]) || 0;
                    const newRecipientBalance = recipientBalance + amount;
                    balances[recipientBalanceIndex][1] = newRecipientBalance;

                    const updatedContent = balances.map(([username, balance]) => `${username}:${balance}`).join('\n');
                    const encodedContent = btoa(updatedContent);

                    await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`, {
                        method: 'PUT',
                        headers: {
                            Authorization: `token ${accessToken}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: 'Update balance via API',
                            content: encodedContent,
                            sha: data.sha,
                        }),
                    });

                    alert(`Successfully gave ${amount} Celestial Coins to ${recipient}. New balance for ${sender}: ${newSenderBalance}`);

                    // Update and display the user balance after giving coins
                    await getUserBalance(sender);
                }
            } else {
                alert('Sender or recipient not found.');
            }
        }

        async function getUserBalance(username) {
            const accessToken = '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'; // Replace this with your GitHub Access Token
            const owner = 'cioudo'; // Replace this with your username or organization name
            const repo = 'creds'; // Replace this with the repository name
            const filePath = 'balances.txt'; // Replace this with the path to the file in the repository

            const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`, {
                method: 'GET',
                headers: {
                    Authorization: `token ${accessToken}`,
                },
            });
            const data = await response.json();
            const currentContent = atob(data.content);
            const balances = currentContent.split('\n').map(line => line.split(':'));
            const userBalanceIndex = balances.findIndex(([storedUsername]) => storedUsername === username);

            if (userBalanceIndex !== -1) {
                const balance = parseFloat(balances[userBalanceIndex][1]) || 0;
                document.getElementById("userBalance").innerText = `Your balance: ${balance} Celestial Coins`;
                document.getElementById("userInfo").style.display = "block";
            } else {
                alert('User not found.');
            }
        }

        async function registerNewUser(username, password) {
            const accessToken = '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'; // Replace this with your GitHub Access Token
            const owner = 'cioudo'; // Replace this with your username or organization name
            const repo = 'creds'; // Replace this with the repository name
            const filePath = 'creds.txt'; // Replace this with the path to the file in the repository

            // Check if user already exists
            const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`, {
                method: 'GET',
                headers: {
                    Authorization: `token ${accessToken}`,
                },
            });
            const data = await response.json();
            const currentContent = atob(data.content);
            const credentials = currentContent.split('\n').map(line => line.split(':'));
            const existingUser = credentials.find(([storedUsername]) => storedUsername === username);

            if (existingUser) {
                alert('Username already exists. Please choose a different username.');
            } else {
                // Add new user to the GitHub file
                await addLineToGitHubFile(`${username}:${password}`, filePath);

                // Set default balance to 0 when registering a new account
                await addLineToGitHubFile(`${username}:0`, 'balances.txt');

                alert('Registration successful! You can now login with your new account.');
            }
        }

        document.getElementById("registerForm").addEventListener("submit", async function(event) {
            event.preventDefault();
            const username = document.getElementById("registerUsername").value;
            const password = document.getElementById("registerPassword").value;

            await registerNewUser(username, password);
        });

        document.getElementById("loginForm").addEventListener("submit", async function(event) {
            event.preventDefault();
            const username = document.getElementById("loginUsername").value;
            const password = document.getElementById("loginPassword").value;

            // Check login credentials with GitHub file
            await loginWithGitHubFile(username, password);
        });

        document.getElementById("giveCoinsForm").addEventListener("submit", async function(event) {
            event.preventDefault();
            const sender = document.getElementById("loginUsername").value; // Logged-in user's username
            const recipient = document.getElementById("recipient").value; // Coins recipient
            const amount = parseFloat(document.getElementById("amount").value);

            if (!isNaN(amount) && amount > 0) {
                await giveCelestialCoins(sender, recipient, amount);
            } else {
                alert("Please enter a valid positive number for the amount.");
            }
        });
    </script>
</body>

</html>
